{
    "cells": [
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "6d180688",
            "metadata": {},
            "outputs": [],
            "source": [
                "from dotenv import load_dotenv\n",
                "\n",
                "load_dotenv()"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "de9e5ff7",
            "metadata": {},
            "outputs": [],
            "source": [
                "from langchain.agents import AgentState\n",
                "\n",
                "class CustomState(AgentState):\n",
                "    favourite_colour: str"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "bd43d283",
            "metadata": {},
            "source": [
                "## Write to state"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "8b3b8c10",
            "metadata": {},
            "outputs": [],
            "source": [
                "from langchain.tools import tool, ToolRuntime\n",
                "from langgraph.types import Command\n",
                "from langchain.messages import ToolMessage\n",
                "\n",
                "@tool\n",
                "def update_favourite_colour(favourite_colour: str, runtime: ToolRuntime) -> Command:\n",
                "    \"\"\"Update the favourite colour of the user in the state once they've revealed it.\"\"\"\n",
                "    return Command(update={\n",
                "        \"favourite_colour\": favourite_colour, \n",
                "        \"messages\": [ToolMessage(\"Successfully updated favourite colour\", tool_call_id=runtime.tool_call_id)]}\n",
                "        )"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "0cf5d1fa",
            "metadata": {},
            "outputs": [],
            "source": [
                "from langchain_aws import ChatBedrock\n",
                "\n",
                "llm = ChatBedrock(\n",
                "    model_id=\"us.meta.llama4-scout-17b-instruct-v1:0\",  # Nota el prefijo \"us.\"\n",
                "    # model_id=\"cohere.command-r-plus-v1:0\",\n",
                "    region_name=\"us-east-1\",\n",
                "    model_kwargs={\n",
                "        \"temperature\": 0.5,\n",
                "        \"max_tokens\": 2048,\n",
                "        \"top_p\": 0.9,\n",
                "    }\n",
                ")\n",
                "\n",
                "# llm = ChatBedrock(\n",
                "#     model_id=\"mistral.mistral-large-2407-v1:0\", # ID de Mistral Large 2\n",
                "#     region_name=\"us-east-1\",                    # Tu regi√≥n de AWS\n",
                "#     model_kwargs={\n",
                "#         \"temperature\": 0.1,\n",
                "#         \"max_tokens\": 2048,\n",
                "#     }\n",
                "# )\n",
                "\n",
                "from langchain.agents import create_agent\n",
                "from langgraph.checkpoint.memory import InMemorySaver\n",
                "\n",
                "agent = create_agent(\n",
                "    llm,\n",
                "    #\"amazon.nova-lite-v1:0\",\n",
                "    \n",
                "    tools=[update_favourite_colour],\n",
                "    checkpointer=InMemorySaver(),\n",
                "    state_schema=CustomState\n",
                ")"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "830d1c91",
            "metadata": {},
            "outputs": [],
            "source": [
                "from langchain.messages import HumanMessage\n",
                "\n",
                "response = agent.invoke(\n",
                "    { \"messages\": [HumanMessage(content=\"My favourite colour is green\")]},\n",
                "    {\"configurable\": {\"thread_id\": \"1\"}}\n",
                ")"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "975f259f",
            "metadata": {},
            "outputs": [],
            "source": [
                "from pprint import pprint\n",
                "\n",
                "pprint(response)"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "90bee050",
            "metadata": {},
            "outputs": [],
            "source": [
                "response = agent.invoke(\n",
                "    { \n",
                "        \"messages\": [HumanMessage(content=\"Hello, how are you?\")],\n",
                "        \"favourite_colour\": \"green\"\n",
                "    },\n",
                "    {\"configurable\": {\"thread_id\": \"10\"}}\n",
                ")\n",
                "\n",
                "pprint(response)"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "6a6c6710",
            "metadata": {},
            "source": [
                "## Read state"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "239059e6",
            "metadata": {},
            "outputs": [],
            "source": [
                "from langchain.agents import create_agent\n",
                "@tool\n",
                "def read_favourite_colour(runtime: ToolRuntime) -> str:\n",
                "    \"\"\"Read the favourite colour of the user from the state.\"\"\"\n",
                "    try:\n",
                "        return runtime.state[\"favourite_colour\"]\n",
                "    except KeyError:\n",
                "        return \"No favourite colour found in state\"\n",
                "\n",
                "agent = create_agent(\n",
                "    #\"amazon.nova-lite-v1:0\",\n",
                "    llm,\n",
                "    tools=[update_favourite_colour, read_favourite_colour],\n",
                "    checkpointer=InMemorySaver(),\n",
                "    state_schema=CustomState\n",
                ")"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "4f4e72b7",
            "metadata": {},
            "outputs": [],
            "source": [
                "response = agent.invoke(\n",
                "    { \"messages\": [HumanMessage(content=\"My favourite colour is green\")]},\n",
                "    {\"configurable\": {\"thread_id\": \"1\"}}\n",
                ")\n",
                "\n",
                "pprint(response)"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "1483dac7",
            "metadata": {},
            "outputs": [],
            "source": [
                "response = agent.invoke(\n",
                "    { \"messages\": [HumanMessage(content=\"What's my favourite colour?\")]},\n",
                "    {\"configurable\": {\"thread_id\": \"1\"}}\n",
                ")\n",
                "\n",
                "pprint(response)"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "f9e0b00e",
            "metadata": {},
            "outputs": [],
            "source": [
                "from langchain_aws import ChatBedrockConverse\n",
                "from langchain.agents import create_agent\n",
                "from langgraph.checkpoint.memory import InMemorySaver\n",
                "from langchain.tools import tool\n",
                "from langchain_core.messages import HumanMessage\n",
                "\n",
                "# Define tus tools\n",
                "@tool\n",
                "def update_favourite_colour(runtime, colour: str) -> str:\n",
                "    \"\"\"Update the favourite colour of the user in the state.\"\"\"\n",
                "    runtime.state[\"favourite_colour\"] = colour\n",
                "    return f\"Favourite colour updated to {colour}\"\n",
                "\n",
                "@tool\n",
                "def read_favourite_colour(runtime) -> str:\n",
                "    \"\"\"Read the favourite colour of the user from the state.\"\"\"\n",
                "    try:\n",
                "        return runtime.state[\"favourite_colour\"]\n",
                "    except KeyError:\n",
                "        return \"No favourite colour found in state\"\n",
                "\n",
                "# Lista de modelos compatibles con Converse API y tool calling\n",
                "models_to_try = [\n",
                "    (\"cohere.command-r-plus-v1:0\", \"Cohere Command R+\"),\n",
                "    (\"cohere.command-r-v1:0\", \"Cohere Command R\"),\n",
                "    (\"mistral.mistral-large-2407-v1:0\", \"Mistral Large 2\"),\n",
                "    (\"anthropic.claude-sonnet-4-20250514-v3:0\", \"Claude Sonnet 4\"),\n",
                "    (\"amazon.nova-pro-v1:0\", \"Amazon Nova Pro\"),\n",
                "]\n",
                "\n",
                "for model_id, model_name in models_to_try:\n",
                "    print(f\"\\n{'='*70}\")\n",
                "    print(f\"üß™ Probando: {model_name}\")\n",
                "    print(f\"üìù Model ID: {model_id}\")\n",
                "    print(f\"{'='*70}\")\n",
                "    \n",
                "    try:\n",
                "        # Usar ChatBedrockConverse en lugar de ChatBedrock\n",
                "        llm = ChatBedrockConverse(\n",
                "            model=model_id,\n",
                "            region_name=\"us-east-1\",\n",
                "            temperature=0.1,\n",
                "            max_tokens=1024,\n",
                "        )\n",
                "        \n",
                "        agent = create_agent(\n",
                "            llm,\n",
                "            tools=[update_favourite_colour, read_favourite_colour],\n",
                "            checkpointer=InMemorySaver(),\n",
                "            state_schema=CustomState\n",
                "        )\n",
                "        \n",
                "        response = agent.invoke(\n",
                "            {\"messages\": [HumanMessage(content=\"My favourite colour is green\")]},\n",
                "            {\"configurable\": {\"thread_id\": \"1\"}}\n",
                "        )\n",
                "        \n",
                "        print(f\"‚úÖ ¬°{model_name} FUNCIONA PERFECTAMENTE!\")\n",
                "        print(f\"\\nüìä Mensajes en la respuesta:\")\n",
                "        for i, msg in enumerate(response['messages']):\n",
                "            print(f\"  {i+1}. {msg.type}: {msg.content[:100]}{'...' if len(str(msg.content)) > 100 else ''}\")\n",
                "        \n",
                "        # Verificar si actualiz√≥ el estado\n",
                "        if 'favourite_colour' in response:\n",
                "            print(f\"\\nüé® Estado actualizado: {response.get('favourite_colour', 'No disponible')}\")\n",
                "        \n",
                "        print(f\"\\n‚ú® RECOMENDACI√ìN: Usa {model_name}\")\n",
                "        break  # Sale si encuentra uno que funciona\n",
                "        \n",
                "    except Exception as e:\n",
                "        print(f\"‚ùå Error con {model_name}:\")\n",
                "        print(f\"   {str(e)[:200]}\")\n",
                "        print(\"   Continuando con el siguiente modelo...\\n\")\n",
                "        continue\n",
                "\n",
                "print(\"\\n\" + \"=\"*70)\n",
                "print(\"üèÅ Pruebas completadas\")\n",
                "print(\"=\"*70)"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "eec54c59",
            "metadata": {},
            "outputs": [],
            "source": [
                "from langchain_aws import ChatBedrock  # ChatBedrock normal\n",
                "from langchain.agents import create_agent\n",
                "from langgraph.checkpoint.memory import InMemorySaver\n",
                "\n",
                "# Estos modelos S√ç funcionan con ChatBedrock:\n",
                "working_models = [\n",
                "    \"anthropic.claude-sonnet-4-20250514-v3:0\",  # Claude\n",
                "    \"amazon.nova-pro-v1:0\",                       # Nova\n",
                "    \"mistral.mistral-large-2407-v1:0\",           # Mistral\n",
                "]\n",
                "\n",
                "llm = ChatBedrock(\n",
                "    model_id=\"mistral.mistral-large-2407-v1:0\",  # Usa uno de estos\n",
                "    region_name=\"us-east-1\",\n",
                "    model_kwargs={\n",
                "        \"temperature\": 0.1,\n",
                "        \"max_tokens\": 1024,\n",
                "    }\n",
                ")\n",
                "\n",
                "agent = create_agent(\n",
                "    llm,\n",
                "    tools=[update_favourite_colour, read_favourite_colour],\n",
                "    checkpointer=InMemorySaver(),\n",
                "    state_schema=CustomState\n",
                ")"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "cbe23f1a",
            "metadata": {},
            "outputs": [],
            "source": [
                "# model_id = \"cohere.command-r-plus-v1:0\"\n",
                "model_id = \"us.meta.llama4-scout-17b-instruct-v1:0\"\n",
                "\n",
                "# Usar ChatBedrockConverse en lugar de ChatBedrock\n",
                "llm = ChatBedrockConverse(\n",
                "    model=model_id,\n",
                "    region_name=\"us-east-1\",\n",
                "    temperature=0.1,\n",
                "    max_tokens=1024,\n",
                ")\n",
                "\n",
                "agent = create_agent(\n",
                "    llm,\n",
                "    tools=[update_favourite_colour, read_favourite_colour],\n",
                "    checkpointer=InMemorySaver(),\n",
                "    state_schema=CustomState\n",
                ")\n",
                "\n",
                "response = agent.invoke(\n",
                "    {\"messages\": [HumanMessage(content=\"My favourite colour is green\")]},\n",
                "    {\"configurable\": {\"thread_id\": \"1\"}}\n",
                ")\n",
                "\n",
                "\n",
                "pprint(response)"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "2ccaa951",
            "metadata": {},
            "outputs": [],
            "source": []
        }
    ],
    "metadata": {
        "kernelspec": {
            "display_name": ".venv",
            "language": "python",
            "name": "python3"
        },
        "language_info": {
            "codemirror_mode": {
                "name": "ipython",
                "version": 3
            },
            "file_extension": ".py",
            "mimetype": "text/x-python",
            "name": "python",
            "nbconvert_exporter": "python",
            "pygments_lexer": "ipython3",
            "version": "3.12.3"
        }
    },
    "nbformat": 4,
    "nbformat_minor": 5
}
